<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Reference Importer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.5;
        }
        
        .container {
            padding: 20px;
            max-width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 12px;
            color: #666;
        }
        
        .method-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .method-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
        }
        
        .method-tab.active {
            background: #18a0fb;
            color: white;
        }
        
        .method-tab:hover:not(.active) {
            background: #e0e0e0;
        }
        
        .method-content {
            display: none;
        }
        
        .method-content.active {
            display: block;
        }
        
        .input-section {
            margin-bottom: 15px;
        }
        
        .input-section label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        #imageData {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 11px;
            resize: vertical;
            background: #fafafa;
        }
        
        #imageData:focus {
            outline: none;
            border-color: #18a0fb;
            background: #ffffff;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: #18a0fb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0d8ce0;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-warning {
            background: #ff9500;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e6850e;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .instructions h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .instructions ol {
            font-size: 12px;
            color: #666;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .keyboard-shortcuts {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 10px;
            color: #666;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .keyboard-shortcuts strong {
            color: #333;
        }
        
        .feature-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .feature-highlight h4 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .feature-highlight p {
            font-size: 10px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Image Reference Importer</h1>
            <p>Import image data copied from Chrome extension to Figma</p>
        </div>

        <div class="feature-highlight">
            <h4>‚ú® New Feature: Google Images Support</h4>
            <p>Now automatically extracts original source URLs from Google Images!</p>
        </div>

        <div class="method-tabs">
            <button class="method-tab active" data-method="manual">üìã Manual Paste</button>
            <button class="method-tab" data-method="auto">üîÑ Auto Sync</button>
        </div>

        <!-- Manual paste method -->
        <div class="method-content active" id="manual-method">
            <div class="input-section">
                <label for="imageData">Image Data (JSON):</label>
                <textarea id="imageData" placeholder="Paste JSON data copied from Chrome extension here..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="importBtn" onclick="handleImport()">üì• Import Image</button>
                <button class="btn btn-secondary" id="clearBtn" onclick="handleClear()">üóëÔ∏è Clear</button>
                <button class="btn btn-warning" id="reimportBtn" onclick="handleReimport()">üîÑ Reimport Last</button>
            </div>
        </div>

        <!-- Auto sync method -->
        <div class="method-content" id="auto-method">
            <div class="instructions">
                <h3>üîÑ Auto Sync Usage:</h3>
                <ol>
                    <li>Right-click on image in Chrome</li>
                    <li>Select "Copy for Figma"</li>
                    <li>Click the button below to fetch automatically</li>
                </ol>
            </div>

            <div class="button-group">
                <button class="btn btn-success" id="fetchBtn" onclick="handleFetch()">üì° Fetch from Chrome Extension</button>
                <button class="btn btn-warning" id="reimportBtn2" onclick="handleReimport()">üîÑ Reimport Last Data</button>
            </div>
        </div>

        <div id="status" class="status info" style="display: none;"></div>

        <div class="instructions">
            <h3>üìñ Usage Guide:</h3>
            <ol>
                <li><strong>Manual Paste:</strong> Paste JSON copied from Chrome into text area</li>
                <li><strong>Auto Sync:</strong> Direct communication with Chrome extension (experimental)</li>
                <li>Last imported data can be reused</li>
                <li><strong>Google Images:</strong> Automatically extracts original source URLs</li>
            </ol>
        </div>

        <div class="keyboard-shortcuts">
            <strong>‚å®Ô∏è Keyboard Shortcuts:</strong> Ctrl/Cmd + Enter (Import) | Ctrl/Cmd + K (Clear) | Ctrl/Cmd + R (Reimport)
        </div>
    </div>

    <script>
        // Inline script for immediate execution
        console.log('=== INLINE SCRIPT LOADING ===');
        
        // Global variables
        var imageDataTextarea, statusDiv;
        
        // Initialize when DOM is ready
        function initializeUI() {
            console.log('=== INITIALIZING UI ===');
            
            // Get DOM elements
            imageDataTextarea = document.getElementById('imageData');
            statusDiv = document.getElementById('status');
            
            console.log('DOM elements found:');
            console.log('- imageDataTextarea:', imageDataTextarea);
            console.log('- statusDiv:', statusDiv);
            
            // Setup tab switching
            setupTabs();
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Setup paste detection
            setupPasteDetection();
            
            console.log('=== UI INITIALIZATION COMPLETE ===');
            
            // Test message sending
            setTimeout(function() {
                sendMessageToFigma({
                    type: 'init',
                    message: 'UI loaded successfully'
                });
            }, 500);
        }
        
        // Setup tab switching
        function setupTabs() {
            var methodTabs = document.querySelectorAll('.method-tab');
            var methodContents = document.querySelectorAll('.method-content');
            
            for (var i = 0; i < methodTabs.length; i++) {
                methodTabs[i].addEventListener('click', function() {
                    var method = this.getAttribute('data-method');
                    console.log('Switching to method:', method);
                    
                    // Activate tab
                    for (var j = 0; j < methodTabs.length; j++) {
                        methodTabs[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    
                    // Switch content
                    for (var k = 0; k < methodContents.length; k++) {
                        methodContents[k].classList.remove('active');
                        if (methodContents[k].id === method + '-method') {
                            methodContents[k].classList.add('active');
                        }
                    }
                });
            }
        }
        
        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    console.log('Keyboard shortcut: Import');
                    handleImport();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    console.log('Keyboard shortcut: Clear');
                    handleClear();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    console.log('Keyboard shortcut: Reimport');
                    handleReimport();
                }
            });
        }
        
        // Setup paste detection
        function setupPasteDetection() {
            if (imageDataTextarea) {
                imageDataTextarea.addEventListener('paste', function(e) {
                    console.log('Paste event detected');
                    setTimeout(function() {
                        var pastedData = imageDataTextarea.value.trim();
                        if (pastedData) {
                            try {
                                var parsed = JSON.parse(pastedData);
                                if (parsed.type === 'image_reference') {
                                    showStatus('Valid image data detected!', 'success');
                                    setTimeout(hideStatus, 2000);
                                } else {
                                    showStatus('Not image reference data. Please use "Copy for Figma" from Chrome extension.', 'error');
                                    setTimeout(hideStatus, 4000);
                                }
                            } catch (error) {
                                console.error('Paste validation error:', error);
                                showStatus('Not JSON format. Please copy again from Chrome extension.', 'error');
                                setTimeout(hideStatus, 4000);
                            }
                        }
                    }, 100);
                });
            }
        }
        
        // Send message to Figma
        function sendMessageToFigma(message) {
            console.log('=== SENDING MESSAGE TO FIGMA ===');
            console.log('Message:', message);
            
            try {
                if (parent && parent.postMessage) {
                    parent.postMessage({
                        pluginMessage: message
                    }, '*');
                    console.log('‚úÖ Message sent via parent.postMessage');
                    return true;
                }
            } catch (e) {
                console.error('‚ùå parent.postMessage failed:', e);
            }
            
            try {
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({
                        pluginMessage: message
                    }, '*');
                    console.log('‚úÖ Message sent via window.parent.postMessage');
                    return true;
                }
            } catch (e) {
                console.error('‚ùå window.parent.postMessage failed:', e);
            }
            
            console.error('‚ùå All message sending methods failed');
            return false;
        }
        
        // Handle import button click
        function handleImport() {
            console.log('=== IMPORT BUTTON CLICKED ===');
            
            var jsonData = imageDataTextarea.value.trim();
            console.log('Textarea value length:', jsonData.length);
            
            if (!jsonData) {
                showStatus('Please enter image data.', 'error');
                return;
            }
            
            try {
                var imageData = JSON.parse(jsonData);
                console.log('‚úÖ Parsed image data:', imageData);
                
                // Data validation
                if (!imageData.type || imageData.type !== 'image_reference') {
                    showStatus('Invalid image reference data. Please use "Copy for Figma" from Chrome extension.', 'error');
                    return;
                }
                
                if (!imageData.imageUrl) {
                    showStatus('Image URL is missing.', 'error');
                    return;
                }
                
                // URL validation
                try {
                    new URL(imageData.imageUrl);
                } catch (urlError) {
                    showStatus('Invalid image URL.', 'error');
                    return;
                }
                
                // Send data to Figma
                console.log('Sending data to Figma:', imageData);
                var messageSent = sendMessageToFigma({
                    type: 'import-image-reference',
                    data: imageData
                });
                
                if (messageSent) {
                    showStatus('Importing image...', 'info');
                } else {
                    showStatus('Failed to send message to Figma. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå JSON parsing error:', error);
                showStatus('Invalid JSON format. Please copy again from Chrome extension.', 'error');
            }
        }
        
        // Handle clear button click
        function handleClear() {
            console.log('Clear button clicked');
            imageDataTextarea.value = '';
            hideStatus();
        }
        
        // Handle reimport button click
        function handleReimport() {
            console.log('Reimport button clicked');
            var messageSent = sendMessageToFigma({
                type: 'reimport-last'
            });
            
            if (messageSent) {
                showStatus('Reimporting last data...', 'info');
            } else {
                showStatus('Failed to send message to Figma. Please try again.', 'error');
            }
        }
        
        // Handle fetch button click
        function handleFetch() {
            console.log('Fetch button clicked');
            var messageSent = sendMessageToFigma({
                type: 'fetch-from-extension'
            });
            
            if (messageSent) {
                showStatus('Fetching data from Chrome extension...', 'info');
            } else {
                showStatus('Failed to send message to Figma. Please try again.', 'error');
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            console.log('Showing status:', type, message);
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = 'status ' + type;
                statusDiv.style.display = 'block';
                
                if (type === 'error') {
                    setTimeout(function() {
                        if (statusDiv.style.display === 'block') {
                            statusDiv.style.opacity = '0.7';
                        }
                    }, 5000);
                }
            }
        }
        
        // Hide status message
        function hideStatus() {
            console.log('Hiding status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
                statusDiv.style.opacity = '1';
            }
        }
        
        // Receive messages from Figma
        window.onmessage = function(event) {
            console.log('=== RECEIVED MESSAGE FROM FIGMA ===');
            console.log('Event data:', event.data);
            var message = event.data.pluginMessage;
            
            if (message) {
                console.log('Plugin message:', message);
                if (message.type === 'success') {
                    showStatus(message.message, 'success');
                    setTimeout(hideStatus, 3000);
                } else if (message.type === 'error') {
                    showStatus(message.message, 'error');
                    setTimeout(hideStatus, 8000);
                } else if (message.type === 'init') {
                    showStatus(message.message, 'info');
                    setTimeout(hideStatus, 2000);
                } else if (message.type === 'info') {
                    showStatus(message.message, 'info');
                }
            }
        };
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeUI);
        } else {
            initializeUI();
        }
        
        console.log('=== INLINE SCRIPT LOADED ===');
    </script>
</body>
</html>
